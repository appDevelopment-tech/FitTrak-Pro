# Руководство по аутентификации FitTrak-Pro

## Обзор системы

FitTrak-Pro использует раздельную систему входа для разных типов пользователей:
- **Вход для учеников** (`/login`) - для учеников
- **Вход для тренеров** (`/login/trener`) - для тренеров

## Структура аутентификации

### Вход для учеников
- **URL**: `/login`
- **Описание**: Стандартная форма входа для учеников
- **Роль**: `pupil`

### Вход для тренеров
- **URL**: `/login/trener`
- **Описание**: Отдельная форма входа для тренеров
- **Роль**: `trainer`

### Маршруты после входа
- **Ученики**: `/dashboard` - персональная панель ученика
- **Тренеры**: `/cabinet` - кабинет тренера

## Тестовые пользователи (режим разработки)

Если Supabase не настроен, система автоматически переключается в тестовый режим с предустановленными пользователями:

### Тренеры
- **Email**: `trainer@fittrak.pro` или `trainer1`
- **Пароль**: `trainer123`
- **Роль**: Тренер
- **Вход**: `/login/trener`
- **Доступ**: Кабинет тренера (`/cabinet`)

### Ученики
- **Email**: `student1@fittrak.pro`, `student2@fittrak.pro`, `student3@fittrak.pro`
- **Пароль**: `student123`
- **Роль**: Ученик
- **Вход**: `/login`
- **Доступ**: Панель ученика (`/dashboard`)

## Настройка Supabase (продакшн)

### Переменные окружения
Создайте файл `.env` в корне проекта:

```env
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
```

### Структура таблиц
Система ожидает следующие таблицы в Supabase:

1. **auth.users** - пользователи Supabase Auth
2. **pupils** - профили учеников
3. **trainers** - профили тренеров

## Логика определения роли

Система автоматически определяет роль пользователя:

1. **Проверка метаданных**: `user_metadata.is_trainer`
2. **Проверка профиля**: Поиск в таблице `pupils`
3. **По умолчанию**: Если не найден в `pupils`, считается тренером

## Безопасность

### Защита маршрутов
- Используется `RoleGuard` для контроля доступа
- Автоматическое перенаправление при неавторизованном доступе
- Проверка ролей на уровне компонентов
- Разделение входов предотвращает неправильный доступ

### Валидация
- Проверка email формата
- Обязательные поля пароля
- Защита от SQL-инъекций через Supabase
- Проверка соответствия типа пользователя и выбранного входа

## Отладка

### Консольные логи
Система выводит подробные логи для отладки:
- `Supabase env check` - проверка конфигурации
- `Auth state changed` - изменения состояния аутентификации
- `signIn called with` - параметры входа
- `Test authentication successful/failed` - результаты тестовой аутентификации

### Проверка состояния
- Откройте Developer Tools → Console
- Проверьте логи аутентификации
- Убедитесь в корректности переменных окружения

## Устранение неполадок

### Проблема: "Неверные данные для входа"
**Решение**: Проверьте правильность email и пароля для тестовых пользователей

### Проблема: "Ученики не могут войти через вход для тренеров"
**Решение**: Используйте правильный вход - `/login` для учеников, `/login/trener` для тренеров

### Проблема: "Тренеры должны использовать вход для тренеров"
**Решение**: Перейдите на `/login/trener` для входа тренеров

### Проблема: "Supabase connection failed"
**Решение**: 
1. Проверьте переменные окружения
2. Убедитесь в доступности Supabase
3. Проверьте настройки CORS

### Проблема: "Access denied"
**Решение**: Убедитесь, что пользователь имеет правильную роль для доступа к маршруту

## Миграция с тестового режима

### Шаг 1: Настройка Supabase
1. Создайте проект в Supabase
2. Настройте аутентификацию
3. Создайте необходимые таблицы

### Шаг 2: Обновление переменных
1. Скопируйте URL и ключ из Supabase
2. Создайте файл `.env` с переменными
3. Перезапустите приложение

### Шаг 3: Тестирование
1. Проверьте вход с реальными данными
2. Убедитесь в корректной работе ролей
3. Протестируйте все маршруты

## Поддержка

При возникновении проблем:
1. Проверьте консоль браузера
2. Убедитесь в корректности конфигурации
3. Проверьте логи Supabase
4. Обратитесь к документации Supabase